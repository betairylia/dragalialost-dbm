<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge"> -->
    <title>Dragalia Lost timelines</title>

    <link rel = "stylesheet" type = "text/css" href = "loading-bar/dist/loading-bar.css"/>
    <link rel = "stylesheet" type = "text/css" href = "style.css"/>
    <script type = "text/javascript" src = "loading-bar/dist/loading-bar.js"></script>

    <script type = "text/javascript" src = "js/localization.js"></script>
    <script type = "text/javascript" src = "js/renderer.js"></script>
    <script type = "text/javascript" src = "js/timeline.js"></script>

</head>
<body>
    <template id = 'bigTimer'>
        <div class = 'timer bigTimer'>
            <div class = 'ld' style = "width: 100%; height: 100%; margin: auto;"></div>
            <div class = 'labels'>
                <div class = 'name_label'></div>
                <div class = 'time_label'></div>
            </div>
        </div>
    </template>

    <template id = 'basicTimer'>
        <li class = 'timer basicTimer'>
            <div class = 'ld' style = "width: 100%; height: fit-content;"></div>
            <div class = 'labels'>
                <div class = 'name_label'></div>
                <div class = 'time_label'></div>
            </div>
        </li>
    </template>

    <template id = "timelineEventItem">
        <ul class = "timeline-event">
            <p id = "idx">
                1.
            </p>
            <p>
                (R) 
                <input id = "min" type = "text" size = "1"/>
                m
                <input id = "sec" type = "text" size = "1"/>
                s
            </p>
            <p>
                <select id = "action">
                </select>
            </p>
        </ul>
    </template>

    <template id = "timelineTreeBlock">
        <div class = "timeline-block">
            <div class = "title">
            </div>
            <div class = "contents">
                <li class = "timeline-content-list">
                    
                </li>
            </div>
        </div>
    </template>

    <div id = 'mainFrame'>
        <div id = 'menu' class = 'framePanel'>
            <p style = "display: flex; justify-content: space-between;">
                语言 / Languages / 言語
                <select id = "language" style = "width: 10em; height: 2em;" onchange = "resetAll();">
                    <option value = "en-us">English</option>
                    <option value = "zh-cn" selected>中文（简体）</option>
                </select>
            </p>
            <p style = "display: flex; flex-direction: row; justify-content: space-between; align-items: center;">
                <button onclick = "resetAll()" style = "height: 3em; width: 15em;" class = "autoLoc_reload"> Reload everything </button>
                <span><input type="checkbox" id="enableAudio" class = "autoLoc_audio" onclick="var cb = document.getElementById('enableAudio'); enableSound = cb.checked;"/> Audio</span>
                <select id = "bossName" style = "height: 2em; width: 8em;" onchange = "resetAll();">
                    <option class = "autoLoc_HBH" value = "HBH">High Brunhilda</option>
                    <option class = "autoLoc_HMC" value = "HMC">High Mercury</option>
                    <option class = "autoLoc_HJP" value = "HJP" selected>High Jupiter</option>
                </select>
            </p>
            <p style = "display: flex; flex-direction: row; justify-content: space-between; align-items: center;">
                <button onclick = "playing = !playing;" style = "height: 2em; min-width: 8em;" class = "autoLoc_play-pause"> Pause / Play </button>
                <button onclick = "tl.reset(); playing = false;" style = "height: 2em; min-width: 8em;" class = "autoLoc_stop"> Stop </button>
                <button onclick = "tl.adjust(-0.5);" style = "height: 2em; min-width: 8em;"> + 0.5s (←) </button>
                <button onclick = "tl.adjust(0.5);" style = "height: 2em; min-width: 8em;"> - 0.5s (→) </button>
            </p>
            <div id = "timeline_preview" class = "long-preview">
                <p style = "text-align: center;" class = "autoLoc_timeline-preview">Timeline preview</p>
                <div id = "timeline_container"></div>
            </div>
        </div>
        <div id = 'timers'>
            <div id = 'mainTimer' class = 'framePanel'>
                <div id = 'specialComment'>
                    <p><button onclick="tl.trigger('break');">BREAK</button></p>
                    <p>Space bar (up) = <strong> BREAK !! </strong></p>
                </div>
                <div id = 'upcomingTimers'>
                    <p class = 'name_label' style = "font-size: 12px">接下来</p>
                    <div id = 'upcomingTimerContainer'>
                    </div>
                </div>
                <div id = 'mainTimerContainer' class = 'framePanel'>
                </div>
            </div>
            <ul id = 'subTimerContainer' class = 'framePanel'></ul>
        </div>
    </div>

    <script>
        var tl;
        var renderer;
        var tlRender;

        var playing = false;

        function resetAll()
        {
            setLocale(document.getElementById('language').value);

            document.getElementById("timeline_container").innerHTML = "";
            document.getElementById("subTimerContainer").innerHTML = "";
            document.getElementById("mainTimerContainer").innerHTML = "";
            document.getElementById("upcomingTimerContainer").innerHTML = "";

            tl = new Timeline(document.getElementById("bossName").value);
            renderer = new Renderer("mainTimerContainer", "subTimerContainer", "upcomingTimerContainer", tl);
            tlRender = new TLRenderer("timeline_container", "timelineEventItem", "timelineTreeBlock", tl);
        }

        var r = document.getElementById("subTimerContainer");

        document.onkeyup = function(ev)
        {
            if(ev.key == ' ')
            {
                tl.trigger('break');
            }
            if(ev.keyCode == 37) // <-
            {
                tl.adjust(-0.5);
            }
            if(ev.keyCode == 39) // ->
            {
                tl.adjust(0.5);
            }
        }
        
        let lastTime = Date.now();

        function upd()
        {
            let nowTime = Date.now();
            let dt = nowTime - lastTime;
            lastTime = nowTime;
            if(this.playing)
            {
                tl.update(dt / 1000.0);
            }
            renderer.render();
            requestAnimationFrame(upd);
        }

        resetAll();
        upd();
    </script>
</body>
</html>
